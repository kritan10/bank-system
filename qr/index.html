<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>QR Scan</title>
	</head>
	<body>
		<div style="display: flex">
			<input id="user" type="text" placeholder="username" />
			<button id="button">Connect to Websocket</button>
		</div>

		<div style="height: 40px"></div>

		<div style="display: flex">
			<input type="text" id="otp" placeholder="qr decoded message" />
			<button id="submit">Sumbit</button>
		</div>

		<div>
			<img id="qr-image" src="/" />
			<h4 id="user-data"></h4>
		</div>

		<div id="response"></div>

		<script type="module">
			import { io } from 'https://cdn.socket.io/4.7.2/socket.io.esm.min.js';

			const QR_INITIATE = 1;
			const QR_RESPONSE = 2;
			const TRANSACTION = 3;

			const user = document.getElementById('user');
			const button = document.getElementById('button');
			const response = document.getElementById('response');
			const submit = document.getElementById('submit');
			const input = document.getElementById('otp');
			const qr_image = document.getElementById('qr-image');
			const user_data = document.getElementById('user-data');

			const socket = io('localhost:3001', { ackTimeout: 30000, retries: 3, autoConnect: false });

			socket.on(QR_INITIATE, (qr, transactionId, receiver) => {
				console.log(qr);
				console.log(receiver);
				qr_image.src = qr;
				user_data.innerHTML = `Scan QR to confirm transaction<br/>
				Sending To:<br/>
				Name: ${receiver.receiver_name}  <br/>
				Account_Number:${receiver.receiver_acc} <br/>
				Amount:${receiver.amount} <br/>
				`;

				submit.onclick = () => {
					if (socket.disconnected) {
						response.innerHTML = 'Socket not connected';
					} else {
						socket.emit(QR_RESPONSE, transactionId, input.value);
					}
					submit.removeEventListener('click');
				};
				response.innerHTML = 'Waiting for input...';
			});

			socket.on(TRANSACTION, (res) => {
				console.log(res);
				response.innerHTML = `${res.meta.message}`;
			});

			button.onclick = () => {
				socket.connect();
				socket.emit('init', user.value);
				button.disabled = true;
				button.innerHTML = `Connected as ${user.value}`;
			};
		</script>
	</body>
</html>
